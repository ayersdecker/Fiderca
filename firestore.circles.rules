rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isCircleMember(circleId) {
      return isSignedIn() && exists(/databases/$(database)/documents/circles/$(circleId)/members/$(request.auth.uid));
    }
    
    function isCircleAdmin(circleId) {
      return isSignedIn() && 
             get(/databases/$(database)/documents/circles/$(circleId)/members/$(request.auth.uid)).data.role == 'admin';
    }
    
    // User profiles - readable by authenticated users
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isOwner(userId);
    }
    
    // Circles - only members can access
    match /circles/{circleId} {
      allow read: if isCircleMember(circleId);
      allow create: if isSignedIn(); // Creating a circle automatically makes you a member
      allow update: if isCircleAdmin(circleId);
      allow delete: if isCircleAdmin(circleId);
      
      // Members subcollection
      match /members/{memberId} {
        allow read: if isCircleMember(circleId);
        // Only admins can add/remove members, except when creating a circle (creator becomes admin)
        allow create: if isCircleAdmin(circleId) || 
                        (request.resource.data.role == 'admin' && !exists(/databases/$(database)/documents/circles/$(circleId)/members/$(request.auth.uid)));
        allow update, delete: if isCircleAdmin(circleId);
      }
      
      // Updates subcollection
      match /updates/{updateId} {
        allow read: if isCircleMember(circleId);
        allow create: if isCircleMember(circleId) && request.resource.data.authorId == request.auth.uid;
        allow delete: if isCircleMember(circleId) && resource.data.authorId == request.auth.uid;
      }
      
      // Tasks subcollection
      match /tasks/{taskId} {
        allow read: if isCircleMember(circleId);
        allow create: if isCircleMember(circleId) && request.resource.data.createdBy == request.auth.uid;
        allow update: if isCircleMember(circleId);
        allow delete: if isCircleMember(circleId);
      }
      
      // Files subcollection
      match /files/{fileId} {
        allow read: if isCircleMember(circleId);
        allow create: if isCircleMember(circleId) && request.resource.data.uploaderId == request.auth.uid;
        allow delete: if isCircleMember(circleId) && resource.data.uploaderId == request.auth.uid;
      }
      
      // Invites subcollection
      match /invites/{inviteId} {
        allow read: if isCircleMember(circleId) || 
                      (isSignedIn() && resource.data.email == request.auth.token.email);
        allow create: if isCircleMember(circleId) && request.resource.data.invitedBy == request.auth.uid;
        allow update: if isSignedIn() && resource.data.email == request.auth.token.email;
        allow delete: if isCircleMember(circleId) || 
                        (isSignedIn() && resource.data.email == request.auth.token.email);
      }
    }
    
    // Legacy collections (keep for backwards compatibility during transition)
    match /userData/{userId} {
      allow read, write: if isOwner(userId);
      allow read: if isSignedIn();
      allow create: if isOwner(userId);
    }
    
    match /connectionRequests/{requestId} {
      allow read: if isSignedIn() && 
                    (resource.data.fromUserId == request.auth.uid || 
                     resource.data.toUserId == request.auth.uid);
      allow create: if isSignedIn() && 
                      request.resource.data.fromUserId == request.auth.uid;
      allow update, delete: if isSignedIn() && 
                              (resource.data.fromUserId == request.auth.uid || 
                               resource.data.toUserId == request.auth.uid);
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
